import google.generativeai as genai
from typing import Dict, Any, List
import json
from app.document_processor.config import GEMINI_API_KEY


class PDFParser:
    """PDFë¥¼ Geminië¡œ íŒŒì‹±í•˜ëŠ” í´ë˜ìŠ¤"""

    def __init__(self):
        """Gemini API ì´ˆê¸°í™”"""
        if not GEMINI_API_KEY:
            raise ValueError("GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

        print(f"ğŸ”‘ Gemini API í‚¤ ë¡œë“œë¨: {GEMINI_API_KEY[:20]}...")  # ë””ë²„ê¹…ìš©
        genai.configure(api_key=GEMINI_API_KEY)

        # Gemini 2.5 Flash ì‚¬ìš©
        self.model = genai.GenerativeModel("models/gemini-2.5-flash")

    def parse_pdf(self, pdf_path: str, output_format: str) -> Dict[str, Any]:
        """PDFë¥¼ íŒŒì‹±í•˜ì—¬ ì§€ì •ëœ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜"""

        # PDF íŒŒì¼ ì—…ë¡œë“œ
        print(f"PDF íŒŒì¼ ì—…ë¡œë“œ ì¤‘: {pdf_path}")
        uploaded_file = genai.upload_file(pdf_path)
        print(f"ì—…ë¡œë“œ ì™„ë£Œ: {uploaded_file.name}")

        prompt = f"""
ë‹¤ìŒ PDF ë¬¸ì„œë¥¼ ë¶„ì„í•˜ì—¬ ì•„ë˜ì˜ JSON í˜•ì‹ìœ¼ë¡œ ì •í™•í•˜ê²Œ ë³€í™˜í•´ì£¼ì„¸ìš”.

**ìµœìš°ì„  ê·œì¹™ - ê°œë… Check ì¶”ì¶œ (ë§¤ìš° ì¤‘ìš”!):**

1. **'ê°œë… Check'ëŠ” í•œ í˜ì´ì§€ë‹¹ ë¬´ì¡°ê±´ í•œ ê°œì”© ì¡´ì¬í•©ë‹ˆë‹¤.**
2. **ë³¸ë¬¸ ì™¼ìª½ ì™¸ê³½ê³¼ ì˜¤ë¥¸ìª½ ì™¸ê³½ ëª¨ë‘**ì—ì„œ 'ê°œë… Check'ë¥¼ ì°¾ì•„ **ë¹ ì§ì—†ì´ ì¶”ì¶œ**í•´ì£¼ì„¸ìš”.

3. **ì¤‘ìš”: concept_checksëŠ” ìµœìƒìœ„ ë ˆë²¨ì´ ì•„ë‹ˆë¼ ê° data ë°°ì—´ì˜ í•­ëª© ë‚´ë¶€ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤!**
   - âŒ ì˜ëª»ëœ ìœ„ì¹˜: ìµœìƒìœ„ ë ˆë²¨ (indexes, dataì™€ ê°™ì€ ë ˆë²¨)
   - âœ… ì˜¬ë°”ë¥¸ ìœ„ì¹˜: ê° data ë°°ì—´ í•­ëª©ì˜ ë‚´ë¶€ (index, index_title, titlesì™€ ê°™ì€ ë ˆë²¨)

4. **ê° index(ì±•í„°)ë³„ë¡œ í•´ë‹¹ í˜ì´ì§€ì˜ ê°œë… Checkë¥¼ ì¶”ì¶œí•˜ì—¬ ê·¸ index í•­ëª© ì•ˆì— í¬í•¨ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.**

5. **ê°œë… Checkì˜ ì˜¬ë°”ë¥¸ ì¶œë ¥ í˜•ì‹:**

{{
    "data": [
        {{
            "index": "01",
            "index_title": "ì‚¬íšŒÂ·ë¬¸í™” í˜„ìƒì˜ ì´í•´",
            "titles": [ ... ],
            "concept_checks": [
                {{
                    "title": "ê°œë… Check",
                    "questions": [
                        {{
                            "question": "1. ë‹¤ì–‘í•œ í•™ë¬¸ ê°„ì˜ êµë¥˜ë¥¼ í†µí•´ ì‚¬íšŒÂ·ë¬¸í™” í˜„ìƒì„ ì´ì²´ì ìœ¼ë¡œ ì—°êµ¬í•˜ëŠ” ê²½í–¥ì„ (  ) ì—°êµ¬ ê²½í–¥ì´ë¼ê³  í•œë‹¤.\\n2. ê¸°ëŠ¥ë¡ ê³¼(  )ì€ ê±°ì‹œì  ê´€ì , (  )ì€ ë¯¸ì‹œì  ê´€ì ì´ë‹¤.",
                            "answer": "1. ê°„í•™ë¬¸ì \\n2. ê°ˆë“±ë¡ , ìƒì§•ì  ìƒí˜¸ ì‘ìš©ë¡ "
                        }}
                    ]
                }}
            ]
        }},
        {{
            "index": "02",
            "index_title": "ì‚¬íšŒÂ·ë¬¸í™” í˜„ìƒì˜ ì—°êµ¬ ë°©ë²•",
            "titles": [ ... ],
            "concept_checks": [
                {{
                    "title": "ê°œë… Check",
                    "questions": [
                        {{
                            "question": "1. (  )ì€ ì‚¬íšŒ ì „ì²´ì˜ í•©ì˜ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬íšŒ ê·œë²”ì´ ì„±ë¦½ëœë‹¤ê³  ë³¸ë‹¤.",
                            "answer": "1. ê¸°ëŠ¥ë¡ "
                        }}
                    ]
                }}
            ]
        }}
    ]
}}

6. **ì¤‘ìš”: questions ë°°ì—´ì˜ ê° í•­ëª©ì€ ë°˜ë“œì‹œ ê°ì²´(object) í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤.**
   - âœ… ì˜¬ë°”ë¥¸ í˜•íƒœ: {{"question": "...", "answer": "..."}}
   - âŒ ì˜ëª»ëœ í˜•íƒœ: ["ì§ˆë¬¸1", "ì§ˆë¬¸2", "ì§ˆë¬¸3"] (ë¬¸ìì—´ ë°°ì—´ ê¸ˆì§€)

7. **ê°œë… Checkì˜ ê° question ê°ì²´ëŠ”:**
   - "question" í•„ë“œ: ì—¬ëŸ¬ ë¬¸ì œë¥¼ ì¤„ë°”ê¿ˆ(\\n)ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ê²°í•©
   - "answer" í•„ë“œ: ê° ë¬¸ì œì˜ ë‹µë³€ì„ ì¤„ë°”ê¿ˆ(\\n)ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ê²°í•©
   - ê° ë¬¸ì œì™€ ë‹µë³€ì€ ë²ˆí˜¸(1., 2., 3. ë“±)ë¡œ ë§¤ì¹­ë¨

8. **ê°œë… Checkì˜ ê´„í˜¸ ì²˜ë¦¬:**
   - question í•„ë“œì—ëŠ” ë¹ˆì¹¸ í‘œì‹œ ê´„í˜¸ "(  )"ë¥¼ **ê·¸ëŒ€ë¡œ ìœ ì§€**í•´ì£¼ì„¸ìš”.

9. **ë‹¤ì‹œ í•œ ë²ˆ ê°•ì¡°: concept_checksëŠ” ì ˆëŒ€ë¡œ ìµœìƒìœ„ ë ˆë²¨ì— ìœ„ì¹˜í•˜ë©´ ì•ˆ ë˜ê³ , ë°˜ë“œì‹œ í•´ë‹¹ indexì˜ data ë°°ì—´ í•­ëª© ë‚´ë¶€ì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤!**

**ì¼ë°˜ ì¶”ì¶œ ê·œì¹™:**
10. ì‘ë‹µì€ ë°˜ë“œì‹œ ìœ íš¨í•œ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
11. JSON ì™¸ì˜ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
12. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(```)ì„ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
13. ë¬¸ì„œì˜ êµ¬ì¡°ë¥¼ ì •í™•í•˜ê²Œ íŒŒì•…í•˜ì—¬ ê³„ì¸µì ìœ¼ë¡œ í‘œí˜„í•´ì£¼ì„¸ìš”.
14. **'ì‚¬íšŒì  í¬ì†Œê°€ì¹˜', 'ìƒì§•', 'ìƒí™© ì •ì˜'** ë“± ë³¸ë¬¸ ì™¸ê³½ì— ìœ„ì¹˜í•œ **ìš©ì–´ ì •ì˜** ë°•ìŠ¤ëŠ” ì¶”ì¶œ ëŒ€ìƒì—ì„œ ì œì™¸í•´ì£¼ì„¸ìš”.
15. **'ê°œë… í”ŒëŸ¬ìŠ¤'ëŠ” ë°˜ë“œì‹œ ì¶”ì¶œì— í¬í•¨**í•˜ë©°, ì´ë¥¼ **s_title** ë˜ëŠ” **ss_title** ì¤‘ ì ì ˆí•œ ê³„ì¸µì— ë„£ì–´ì£¼ì„¸ìš”.
16. **'contents' í•„ë“œì— ì—¬ëŸ¬ í•­ëª©ì´ ë‚˜ì—´ë  ê²½ìš°, ìŠ¬ë˜ì‹œ(/)ë¥¼ êµ¬ë¶„ìë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.**
17. **'contents' í•„ë“œì˜ ì—¬ëŸ¬ ë¬¸ì¥ì´ë‚˜ ëª©ë¡ í•­ëª©ì€ í…ìŠ¤íŠ¸ ë‚´ì—ì„œ ë°˜ë“œì‹œ ë¶ˆë¦¿ í¬ì¸íŠ¸(â€¢)ì™€ ì¤„ ë°”ê¿ˆ(\\n)ì„ ì‚¬ìš©í•˜ì—¬ ì›ë³¸ ë¬¸ì„œì™€ ê°™ì´ ëª©ë¡ í˜•íƒœë¡œ í‘œí˜„í•´ì£¼ì„¸ìš”. ê° í•­ëª©ì€ ë…ë¦½ëœ ì¤„ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.** (ì˜ˆ: "â€¢ ì²« ë²ˆì§¸ í•­ëª©\\nâ€¢ ë‘ ë²ˆì§¸ í•­ëª©")
18. ëª¨ë“  í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ë¹ ì§ì—†ì´ í¬í•¨í•´ì£¼ì„¸ìš”.
19. s_title, ss_title ê³„ì¸µì´ ë¶„ë¦¬ë˜ëŠ”ê²Œ ëˆ„ë½ë˜ì§€ ì•Šë„ë¡ í•´ì£¼ì„¸ìš”.
20. ss_title ê³„ì¸µì„ ì¸ì‹í•˜ì§€ ëª»í•˜ê³  s_titleì˜ contentsê°€ ë‘í…ê²Œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ëŠ” ê²ƒì— ì£¼ì˜í•´ì¤˜. â‘  ëª°ê°€ì¹˜ì„±, â‘¡ ì¡´ì¬ ë²•ì¹™ ê°™ì€ ìˆ«ìê¸°í˜¸ëŠ” ss_title ê³„ì¸µìœ¼ë¡œ ë¶„ë¦¬í•´ì•¼ í•˜ëŠ” ê²ƒì„ ëˆ„ë½ë˜ì§€ ì•Šê²Œ ì‹ ê²½ì¨ì¤˜.

**ì¶œë ¥ í˜•ì‹:**
{output_format}

**âš ï¸ ìµœì¢… í™•ì¸ ì‚¬í•­:**
- concept_checksëŠ” **ì ˆëŒ€ë¡œ** ìµœìƒìœ„ ë ˆë²¨(indexes, dataì™€ ê°™ì€ ë ˆë²¨)ì— ìˆìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤!
- concept_checksëŠ” **ë°˜ë“œì‹œ** ê° data ë°°ì—´ í•­ëª©ì˜ ë‚´ë¶€(titlesì™€ ê°™ì€ ë ˆë²¨)ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤!
- ê° í˜ì´ì§€ì˜ ê°œë… CheckëŠ” í•´ë‹¹ í˜ì´ì§€ê°€ ì†í•œ indexì˜ data í•­ëª© ì•ˆì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤!
- questions ë°°ì—´ ì•ˆì˜ ê° í•­ëª©ì€ {{"question": "...", "answer": "..."}} í˜•íƒœì˜ ê°ì²´ì—¬ì•¼ í•˜ë©°, ë¬¸ìì—´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤!

ìœ„ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¼ JSONë§Œ ì¶œë ¥í•´ì£¼ì„¸ìš”.
"""

        try:
            print("Geminië¡œ PDF ë¶„ì„ ì¤‘...")
            response = self.model.generate_content([uploaded_file, prompt])

            # ì—…ë¡œë“œëœ íŒŒì¼ ì‚­ì œ
            genai.delete_file(uploaded_file.name)
            print("ì„ì‹œ íŒŒì¼ ì‚­ì œ ì™„ë£Œ")

            response_text = response.text.strip()

            # ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
            response_text = (
                response_text.replace("```json", "").replace("```", "").strip()
            )

            # JSON íŒŒì‹±
            parsed_data = json.loads(response_text)
            print("JSON íŒŒì‹± ì„±ê³µ!")
            return parsed_data

        except json.JSONDecodeError as e:
            print(f"JSON íŒŒì‹± ì‹¤íŒ¨: {e}")
            print(f"ì‘ë‹µ ë‚´ìš©:\n{response_text[:500]}...")
            raise ValueError(f"JSON íŒŒì‹± ì‹¤íŒ¨: {e}\nì‘ë‹µ: {response_text[:500]}...")
        except Exception as e:
            try:
                genai.delete_file(uploaded_file.name)
            except:
                pass
            raise ValueError(f"PDF íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

    def process_concept_checks(
        self, concept_checks: List[Dict[str, Any]]
    ) -> Dict[str, Any]:
        """
        ê°œë… Check í•­ëª©ì„ Geminië¡œ ê°€ê³µí•˜ì—¬ ì •ì œëœ í˜•íƒœë¡œ ë°˜í™˜

        Args:
            concept_checks: s_title == "ê°œë… Check"ì¸ í•­ëª© ë¦¬ìŠ¤íŠ¸

        Returns:
            ê°€ê³µëœ ê°œë… Check ë°ì´í„°
        """

        # ì…ë ¥ ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
        concept_checks_json = json.dumps(concept_checks, ensure_ascii=False, indent=2)

        prompt = f"""
ë‹¤ìŒì€ êµê³¼ì„œì—ì„œ ì¶”ì¶œí•œ "ê°œë… Check" í•­ëª©ë“¤ì…ë‹ˆë‹¤. ê° í•­ëª©ì„ ë¶„ì„í•˜ì—¬ ì •ì œëœ í˜•íƒœë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”.

**ì…ë ¥ ë°ì´í„°:**
{concept_checks_json}

**ì²˜ë¦¬ ê·œì¹™:**
1. ê° ê°œë… Check í•­ëª©ì˜ `contents` í•„ë“œì—ëŠ” ë¹ˆì¹¸ ë¬¸ì œë“¤ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤
2. `contents`ì˜ ê° ë¬¸ì œì—ì„œ ê´„í˜¸ "(  )"ë¥¼ ì œê±°í•˜ê³ , ì™„ì „í•œ ë¬¸ì¥ í˜•íƒœì˜ ì§ˆë¬¸ìœ¼ë¡œ ë³€í™˜í•˜ì„¸ìš”
3. `answer` í•„ë“œì˜ ë‹µë³€ê³¼ ë§¤ì¹­í•˜ì—¬ ê° ì§ˆë¬¸ì— ëŒ€í•œ ì •ë‹µì„ ì—°ê²°í•˜ì„¸ìš”
4. ë²ˆí˜¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ë§¤ì¹­í•˜ì„¸ìš” (ì˜ˆ: "1. ..." -> "1. ...")
5. ì¶œë ¥ í˜•ì‹ì€ ì•„ë˜ JSON êµ¬ì¡°ë¥¼ ì •í™•íˆ ë”°ë¼ì£¼ì„¸ìš”
6. JSON ì™¸ì˜ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”
7. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(```)ì„ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”

**ì¶œë ¥ í˜•ì‹:**
{{
    "concept_checks": [
        {{
            "title": "ê°œë… Check",
            "questions": [
                {{
                    "number": 1,
                    "question": "ì™„ì „í•œ ë¬¸ì¥ í˜•íƒœì˜ ì§ˆë¬¸ (ê´„í˜¸ ì œê±°ë¨)",
                    "answer": "ì •ë‹µ"
                }},
                {{
                    "number": 2,
                    "question": "ì™„ì „í•œ ë¬¸ì¥ í˜•íƒœì˜ ì§ˆë¬¸",
                    "answer": "ì •ë‹µ"
                }}
            ]
        }}
    ]
}}

**ì˜ˆì‹œ:**
ì…ë ¥:
- contents: "1. ë‹¤ì–‘í•œ í•™ë¬¸ ê°„ì˜ êµë¥˜ë¥¼ í†µí•´ ì‚¬íšŒÂ·ë¬¸í™” í˜„ìƒì„ ì´ ì²´ì ìœ¼ë¡œ ì—°êµ¬í•˜ëŠ” ê²½í–¥ì„ (  ) ì—°êµ¬ ê²½í–¥ì´ë¼ê³  í•œë‹¤."
- answer: "1. ê°„í•™ë¬¸ì "

ì¶œë ¥:
{{
    "question": "ë‹¤ì–‘í•œ í•™ë¬¸ ê°„ì˜ êµë¥˜ë¥¼ í†µí•´ ì‚¬íšŒÂ·ë¬¸í™” í˜„ìƒì„ ì´ ì²´ì ìœ¼ë¡œ ì—°êµ¬í•˜ëŠ” ê²½í–¥ì„ ë¬´ì—‡ì´ë¼ê³  í•˜ëŠ”ê°€?",
    "answer": "ê°„í•™ë¬¸ì  ì—°êµ¬ ê²½í–¥"
}}

ìœ„ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¼ JSONë§Œ ì¶œë ¥í•´ì£¼ì„¸ìš”.
"""

        try:
            print("Geminië¡œ ê°œë… Check ê°€ê³µ ì¤‘...")
            response = self.model.generate_content(prompt)

            response_text = response.text.strip()

            # ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
            response_text = (
                response_text.replace("```json", "").replace("```", "").strip()
            )

            # JSON íŒŒì‹±
            processed_data = json.loads(response_text)
            print("ê°œë… Check ê°€ê³µ ì„±ê³µ!")

            return processed_data

        except json.JSONDecodeError as e:
            print(f"JSON íŒŒì‹± ì‹¤íŒ¨: {e}")
            print(f"ì‘ë‹µ ë‚´ìš©:\n{response_text[:500]}...")
            raise ValueError(f"JSON íŒŒì‹± ì‹¤íŒ¨: {e}\nì‘ë‹µ: {response_text[:500]}...")
        except Exception as e:
            raise ValueError(f"ê°œë… Check ê°€ê³µ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
